<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/login.css">
    <link rel="icon" type="image/png" href="../static/images/ufcg.png">
    <title>EurecaAI - Login</title>
    <script>
        const hoursExpiredIn = 24

        function showAlert(loginAlert, msg) {
            loginAlert.innerText = msg;

            setTimeout(() => {
                loginAlert.innerText = msg;
            }, 3000);
        }

        function handleLogin() {
            const login = document.getElementById("login").value;
            const password = document.getElementById("password").value;
            const loginAlert = document.getElementById("login-alert");
            const apiURL = `https://eureca.sti.ufcg.edu.br/as/tokens?horas-duracao=${hoursExpiredIn}`;

            if (!login || !password) {
                showAlert(loginAlert, "Por favor, inserir o login e a senha");
                return;
            }
            
            console.log("ok")

            fetch(apiURL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    credentials: {
                        username: login,
                        password: password
                    }
                })
            }).then(response => response.json())
            .then(data => {
                console.log(data)
                if (data.message === "Authentication error.") {
                    showAlert(loginAlert, "Login ou senha inválida");
                } else {
                    fetch("https://eureca.sti.ufcg.edu.br/as/profile", { 
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            "token-de-autenticacao": data.token
                        }
                    })
                    .then(res => res.json())
                    .then(profileData => {
                        store_token("token", data.token);
                        store_token("profile", JSON.stringify(profileData));
                        window.location.href = "/";
                    });                    
                }
            })
            .catch(error => {
                showAlert(loginAlert, "Erro ao fazer login");
            });
        }

        async function store_token(name, value) {
            const date = new Date();
            date.setTime(date.getTime() + hoursExpiredIn * 60 * 60 * 1000);
            document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
        }

    </script>
</head>
<body>
    <header class="header_main">
        <img src="./static/images/logo_ufcg.png" onClick="window.location.href='/'">
    </header>
    <main>
        <section>
            <article>
                <div class="login_container">
                    <h2 class="title_login_container">Login com os dados do Controle Acadêmico</h2>
                    <div class="credentials">
                        <label for="login" class="credentials_login_container_text">Login</label>
                        <input type="text" id="login" class="input_field" placeholder="Digite sua matrícula">
                    </div>
                    <div class="credentials">
                        <label for="password" class="credentials_login_container_text">Senha</label>
                        <input type="password" id="password" class="input_field" placeholder="Digite sua senha">
                    </div>
                    <p id="login-alert" style="color: red;"></p>
                    <button class="login_button" onClick="handleLogin()">Fazer Login</button>
                </div>                
            </article>
        </section>
    </main>
</body>
</html>