<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/ufcg.png') }}">

    <link rel="apple-touch-icon" sizes="180x180" href="../assets/favicon_package_v0.16/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon_package_v0.16//favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon_package_v0.16//favicon-16x16.png">
    <link rel="manifest" href="../assets/favicon_package_v0.16//site.webmanifest">
    <link rel="mask-icon" href="../assets/favicon_package_v0.16//safari-pinned-tab.svg" color="#40c4ff">
    <meta name="msapplication-TileColor" content="#2d89ef">
    <meta name="theme-color" content="#ffffff">

    <meta charset="UTF-8"> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">    
    <link rel="stylesheet" href="{{ url_for('static', filename='materialize/css/materialize.min.css') }}"  media="screen,projection"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" 
    integrity="sha512-dfX5uYVXzyU8+KHqj8bjo7UkOdg18PaOtpa48djpNbZHwExddghZ+ZmzWT06R5v6NSk3ZUfsH6FNEDepLx9hPQ==" 
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="login.js" type="module"></script>
    <script src="../components/toast.js" type="text/javascript"></script> 
    <title>EurecaAI - Login</title>
    <script>
        const hoursExpiredIn = 24

        function showAlert(loginAlert, msg) {
            loginAlert.innerText = msg;

            setTimeout(() => {
                loginAlert.innerText = msg;
            }, 3000);
        }

        function handleLogin() {
            const login = document.getElementById("login").value;
            const password = document.getElementById("password").value;
            const loginAlert = document.getElementById("login-alert");
            const apiURL = `https://eureca.sti.ufcg.edu.br/as/tokens?horas-duracao=${hoursExpiredIn}`;

            if (!login || !password) {
                showAlert(loginAlert, "Por favor, inserir o login e a senha");
                return;
            }
            
            console.log("ok")

            fetch(apiURL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    credentials: {
                        username: login,
                        password: password
                    }
                })
            }).then(response => response.json())
            .then(data => {
                console.log(data)
                if (data.message === "Authentication error.") {
                    showAlert(loginAlert, "Login ou senha inválida");
                } else {
                    fetch("http://127.0.0.1:8000/login_enter", { 
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            "token-de-autenticacao": data.token
                        }
                    })
                    .then(res => res.json())
                    .then(profileData => {
                        profileData.token = data.token;
                        store_token("profile", JSON.stringify(profileData));
                        window.location.href = "/";
                    });                    
                }
            })
            .catch(error => {
                showAlert(loginAlert, "Erro ao fazer login");
            });
        }

        async function store_token(name, value) {
            const date = new Date();
            date.setTime(date.getTime() + hoursExpiredIn * 60 * 60 * 1000);
            document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
        }

        function levarPaginaInicial() {
            window.location.href = "/";
        }

        document.addEventListener("DOMContentLoaded", function() {
            document.addEventListener("keydown", function(e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    handleLogin();
                }
            })
        })

    </script>
</head>
<body class="valign-wrapper">

    <div class="container">
    
        <div class="row">

            <div class="col s12">
                <div class="center-align">
                    <img class="responsive-img vertical" src="{{ url_for('static', filename='images/Eureca_AI_logo.png') }}" onclick="levarPaginaInicial()">
                </div>
            </div>

            <div class="col s4"><!-- coluna só pra centralizar o conteúdo real --></div>

            <div class="col s4">
                <div class="card azul-escuro-1">
                    <div class="card-content white-text">
                        <p class="font text thin">Seja bem-vindo! Insira as suas credenciais do controle acadêmico para receber seu token de acesso.</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content text-azul-escuro-1 center-align">
                        
                        <div>

                            <div class="input-field col s12">
                                <input class="texto-azul-escuro-1" placeholder="Usuário" id="login" type="text" class="validate">
                            </div>

                            <div class="input-field col s12">
                                <input class="texto-azul-escuro-1" placeholder="Senha" id="password" type="password" class="validate">
                            </div>
                            <p id="login-alert" style="color: red;"></p>
                            <button onClick="handleLogin()" id="loginButton" class="btn waves-effect waves-light azul-escuro-1" name="action" type="submit">Entrar</button>
                        
                        </div>
                    </div>

                </div>

            </div>
            
            <div class="col s4"><!-- coluna só pra centralizar o conteúdo real --></div>

        </div>    
        
        <footer class="font texto-azul-escuro-1 center-align light">
            © 2025 UFCG - Todos os direitos reservados.
        </footer>
        <br>
        <br>


    </div>

</body>
</html>